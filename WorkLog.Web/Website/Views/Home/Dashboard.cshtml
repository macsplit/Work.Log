@model HierarchyViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="dashboard-layout">
    <!-- Left sidebar: Hierarchy navigation -->
    <aside class="hierarchy-panel">
        <div class="panel-header">
            <h2>Navigate</h2>
            <a asp-controller="Session" asp-action="Create"
               asp-route-date="@Model.SelectedDate?.ToString("yyyy-MM-dd")"
               class="btn btn-primary btn-sm">+ New Session</a>
        </div>

        <!-- Tree hierarchy: Years -> Months -> Weeks -> Days -->
        @if (Model.Years.Any())
        {
            <ul class="hierarchy-list tree-root">
                @foreach (var year in Model.Years)
                {
                    var yearSelected = Model.SelectedYear == year;
                    var avgPerWeek = Model.YearAverageHoursPerWeek.TryGetValue(year, out var yAvg) ? yAvg : 0.0;
                    <li class="tree-node @(yearSelected ? "expanded" : "")">
                        <a asp-action="Dashboard" asp-route-year="@(yearSelected ? null : year)" class="tree-item @(yearSelected ? "selected" : "")">
                            <span class="tree-icon">@(yearSelected ? "â–¼" : "â–¶")</span>
                            @year (@avgPerWeek.ToString("0.0")h/wk)
                        </a>

                        @if (yearSelected && Model.Months.Any())
                        {
                            <ul class="hierarchy-list tree-children">
                                @foreach (var month in Model.Months)
                                {
                                    var monthSelected = Model.SelectedMonth == month;
                                    var mAvg = Model.MonthAverageHoursPerWeek.TryGetValue(month, out var mAvgVal) ? mAvgVal : 0.0;
                                    <li class="tree-node @(monthSelected ? "expanded" : "")">
                                        <a asp-action="Dashboard"
                                           asp-route-year="@Model.SelectedYear"
                                           asp-route-month="@(monthSelected ? null : month)"
                                           class="tree-item @(monthSelected ? "selected" : "")">
                                            <span class="tree-icon">@(monthSelected ? "â–¼" : "â–¶")</span>
                                            @Model.GetMonthName(month) (@mAvg.ToString("0.0")h/wk)
                                        </a>

                                        @if (monthSelected && Model.Weeks.Any())
                                        {
                                            <ul class="hierarchy-list tree-children">
                                                @foreach (var week in Model.Weeks)
                                                {
                                                    var weekSelected = Model.SelectedWeek == week;
                                                    var wTotal = Model.WeekTotalHours.TryGetValue(week, out var wTotalVal) ? wTotalVal : 0.0;
                                                    <li class="tree-node @(weekSelected ? "expanded" : "")">
                                                        <a asp-action="Dashboard"
                                                           asp-route-year="@Model.SelectedYear"
                                                           asp-route-month="@Model.SelectedMonth"
                                                           asp-route-week="@(weekSelected ? null : week)"
                                                           class="tree-item @(weekSelected ? "selected" : "")">
                                                            <span class="tree-icon">@(weekSelected ? "â–¼" : "â–¶")</span>
                                                            @Model.GetWeekLabel(week) (@wTotal.ToString("0.0")h)
                                                        </a>

                                                        @if (weekSelected && Model.Days.Any())
                                                        {
                                                            <ul class="hierarchy-list tree-children">
                                                                @foreach (var day in Model.Days)
                                                                {
                                                                    var daySelected = Model.SelectedDate == day;
                                                                    var dTotal = Model.DayTotalHours.TryGetValue(day, out var dTotalVal) ? dTotalVal : 0.0;
                                                                    <li class="tree-node">
                                                                        <a asp-action="Dashboard"
                                                                           asp-route-year="@Model.SelectedYear"
                                                                           asp-route-month="@Model.SelectedMonth"
                                                                           asp-route-week="@Model.SelectedWeek"
                                                                           asp-route-date="@day.ToString("yyyy-MM-dd")"
                                                                           class="tree-item tree-leaf @(daySelected ? "selected" : "")">
                                                                            <span class="tree-icon">ðŸ“…</span>
                                                                            @Model.GetDayLabel(day) (@dTotal.ToString("0.0")h)
                                                                        </a>
                                                                    </li>
                                                                }
                                                            </ul>
                                                        }
                                                    </li>
                                                }
                                            </ul>
                                        }
                                    </li>
                                }
                            </ul>
                        }
                    </li>
                }
            </ul>
        }
        else
        {
            <p class="empty-message">No sessions recorded yet</p>
        }
    </aside>

    <!-- Main content area -->
    <main class="content-panel">
        @if (Model.SelectedDate.HasValue)
        {
            <div class="day-header">
                <h1>@Model.SelectedDate.Value.ToString("dddd, MMMM d, yyyy")</h1>
                <div class="day-summary">
                    <span class="total-hours">@Model.TotalHours hours</span>
                    <span class="session-count">@Model.Sessions.Count session(s)</span>
                </div>
            </div>

            <!-- Session list -->
            <div class="sessions-panel">
                @if (Model.Sessions.Any())
                {
                    <div class="session-list">
                        @foreach (var session in Model.Sessions)
                        {
                            <div class="session-card" data-session-id="@session.Id">
                                <div class="session-header">
                                    <span class="session-time">@session.TimeHours hour(s)</span>
                                    @if (session.Tag != null)
                                    {
                                        <span class="tag-badge">@session.Tag.Name</span>
                                    }
                                    <div class="session-actions">
                                        <a asp-controller="Session" asp-action="Edit" asp-route-id="@session.Id"
                                           class="btn btn-sm">Edit</a>
                                        <form asp-controller="Session" asp-action="Delete" asp-route-id="@session.Id"
                                              method="post" class="delete-form"
                                              onsubmit="return confirm('Are you sure you want to delete this session?');">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    </div>
                                </div>
                                <div class="session-description">
                                    <p>@session.Description</p>
                                </div>
                                @if (!string.IsNullOrEmpty(session.Notes))
                                {
                                    <div class="session-notes">
                                        <strong>Notes:</strong>
                                        <div class="session-notes-content">@session.Notes</div>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(session.NextPlannedStage))
                                {
                                    <div class="session-next">
                                        <strong>Next Planned Stage:</strong>
                                        <p>@session.NextPlannedStage</p>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <p>No sessions for this day</p>
                        <a asp-controller="Session" asp-action="Create"
                           asp-route-date="@Model.SelectedDate.Value.ToString("yyyy-MM-dd")"
                           class="btn btn-primary">Add First Session</a>
                    </div>
                }

                @if (Model.TagTotals.Any())
                {
                    <div class="tag-totals-strip">
                        <span class="tag-totals-label">Week:</span>
                        @foreach (var tagTotal in Model.TagTotals)
                        {
                            <span class="tag-total-badge">@tagTotal.TagName (@tagTotal.TotalHours.ToString("0.0")h)</span>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="welcome-message">
                <h1>Welcome to Work Log</h1>
                <p>Select a date from the hierarchy to view or add work sessions.</p>
                @if (!Model.Years.Any())
                {
                    <a asp-controller="Session" asp-action="Create" class="btn btn-primary">Add Your First Session</a>
                }
            </div>
        }
    </main>
</div>
